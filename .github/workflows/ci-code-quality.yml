name: CI - Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  check-documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "❌ README.md manquant"
            exit 1
          fi
          echo "✅ README.md présent"

      - name: Check documentation files
        run: |
          required_docs=(
            "DOCUMENTATION_VOCALYX_CLI.md"
            "DOCUMENTATION_LOGS.md"
          )
          
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "✅ $doc présent"
            else
              echo "⚠️  $doc manquant"
            fi
          done

      - name: Validate Markdown syntax
        run: |
          # Vérifier la syntaxe Markdown basique
          if command -v markdownlint &> /dev/null || npm list -g markdownlint-cli2 &> /dev/null; then
            echo "Markdown linting disponible"
          else
            echo "⚠️  markdownlint non installé, saut de la validation"
          fi

  check-config-files:
    name: Configuration Files Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check .env.example exists
        run: |
          if [ -f .env.example ]; then
            echo "✅ .env.example présent"
          else
            echo "⚠️  .env.example manquant"
          fi

      - name: Check .gitignore
        run: |
          if [ -f .gitignore ]; then
            echo "✅ .gitignore présent"
            
            # Vérifier que les fichiers sensibles sont ignorés
            if grep -q "\.env" .gitignore; then
              echo "✅ .env est dans .gitignore"
            else
              echo "⚠️  .env n'est pas dans .gitignore"
            fi
          else
            echo "❌ .gitignore manquant"
            exit 1
          fi

      - name: Check for secrets in code
        run: |
          # Vérifier qu'il n'y a pas de secrets hardcodés évidents
          echo "Recherche de patterns suspects..."
          
          if grep -r "password.*=.*['\"][^'\"]\{8,\}['\"]" --include="*.py" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".example" | grep -v ".github"; then
            echo "⚠️  Mots de passe potentiels détectés dans le code (vérifiez manuellement)"
          else
            echo "✅ Aucun mot de passe évident détecté"
          fi

      - name: Validate Makefile
        run: |
          if [ -f Makefile ]; then
            # Vérifier que le Makefile est valide
            make help > /dev/null || true
            echo "✅ Makefile présent et valide"
          else
            echo "❌ Makefile manquant"
            exit 1
          fi
