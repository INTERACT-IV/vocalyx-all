#!/bin/bash

# CLI Vocalyx - Outil en ligne de commande pour Vocalyx
# Usage: ./vocalyx_cli --action=transcribe <fichier_audio> <nom_projet> [options]

set -e

# Chemin du fichier de configuration
CONFIG_FILE="${HOME}/.vocalyx_config"

# Charger la configuration depuis le fichier si elle existe
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Configuration par d√©faut (apr√®s chargement du fichier de config)
API_URL="${VOCALYX_API_URL:-http://localhost:8000}"
USERNAME="${VOCALYX_USERNAME:-admin}"
PASSWORD="${VOCALYX_PASSWORD:-}"

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonction d'aide g√©n√©rale
show_help() {
    cat << EOF
Usage: $0 --action=<action> [arguments] [options]

Actions disponibles:
  transcribe    Cr√©er une transcription audio
  status        R√©cup√©rer le statut et le r√©sultat d'une transcription
  enrich        D√©clencher l'enrichissement d'une transcription

Options globales:
  -u, --username USERNAME    Nom d'utilisateur (d√©faut: admin ou depuis config)
  -p, --password PASSWORD    Mot de passe (ou depuis config)
  -a, --api-url URL          URL de l'API (d√©faut: http://localhost:8000)
  -h, --help                 Afficher cette aide

Variables d'environnement:
  VOCALYX_API_URL            URL de l'API Vocalyx
  VOCALYX_USERNAME           Nom d'utilisateur
  VOCALYX_PASSWORD            Mot de passe
  VOCALYX_PROJECT_API_KEY    Cl√© API du projet (si fournie, skip l'authentification)

Configuration:
  Le script peut lire les credentials depuis ~/.vocalyx_config:
    VOCALYX_USERNAME=admin
    VOCALYX_PASSWORD=mon_mot_de_passe
    VOCALYX_API_URL=http://localhost:8000

Pour l'aide sp√©cifique √† une action:
  $0 --action=transcribe --help
  $0 --action=status --help
  $0 --action=enrich --help
EOF
}

# Fonction d'aide pour l'action transcribe
show_transcribe_help() {
    cat << EOF
Action: transcribe

Cr√©er une transcription audio sur Vocalyx.

Usage: $0 --action=transcribe -f <fichier_audio> -P <nom_projet> [options]

Arguments requis:
  -f, --file FILE            Chemin vers le fichier audio √† transcrire
  -P, --project PROJECT      Nom du projet Vocalyx

Options sp√©cifiques √† transcribe:
  -m, --model MODEL          Mod√®le Whisper (tiny|base|small|medium|large-v3-turbo, d√©faut: small)
  --no-vad                   D√©sactiver VAD (Voice Activity Detection)
  --diarization              Activer la diarisation des locuteurs
  -v, --verbose              Afficher les messages d√©taill√©s (par d√©faut: JSON uniquement)

Options globales:
  -u, --username USERNAME    Nom d'utilisateur (d√©faut: admin ou depuis config)
  -p, --password PASSWORD    Mot de passe (ou depuis config)
  -a, --api-url URL          URL de l'API (d√©faut: http://localhost:8000)

Exemples:
  $0 --action=transcribe -f audio.wav -P ISICOMTECH
  $0 --action=transcribe --file audio.mp3 --project MON_PROJET --model medium --diarization
  $0 --action=transcribe -f audio.wav -P ISICOMTECH --no-vad
EOF
}

# Fonction d'aide pour l'action status
show_status_help() {
    cat << EOF
Action: status

R√©cup√©rer le statut et le r√©sultat d'une transcription.

Usage: $0 --action=status -tid <transcription_id> [options]

Arguments requis:
  -tid, --transcription-id ID    ID de la transcription √† r√©cup√©rer

Options sp√©cifiques √† status:
  -v, --verbose              Afficher les messages d√©taill√©s (par d√©faut: JSON uniquement)

Options globales:
  -u, --username USERNAME    Nom d'utilisateur (d√©faut: admin ou depuis config)
  -p, --password PASSWORD    Mot de passe (ou depuis config)
  -a, --api-url URL          URL de l'API (d√©faut: http://localhost:8000)

Exemples:
  $0 --action=status -tid abc123-def456-ghi789
  $0 --action=status --transcription-id abc123-def456-ghi789
EOF
}

# Fonction d'aide pour l'action enrich
show_enrich_help() {
    cat << EOF
Action: enrich

D√©clencher l'enrichissement d'une transcription existante.

Usage: $0 --action=enrich -tid <transcription_id> [options]

Arguments requis:
  -tid, --transcription-id ID    ID de la transcription √† enrichir

Options sp√©cifiques √† enrich:
  -m, --llm-model MODEL         Mod√®le LLM (qwen2.5-7b-instruct|mistral-7b-instruct|phi-3-mini)
  --text-correction              Activer la correction du texte (orthographe, grammaire)
  --prompts-file FILE           Fichier JSON contenant les prompts personnalis√©s
  -v, --verbose                 Afficher les messages d√©taill√©s (par d√©faut: JSON uniquement)

Options globales:
  -u, --username USERNAME    Nom d'utilisateur (d√©faut: admin ou depuis config)
  -p, --password PASSWORD    Mot de passe (ou depuis config)
  -a, --api-url URL          URL de l'API (d√©faut: http://localhost:8000)

Exemples:
  $0 --action=enrich -tid abc123-def456-ghi789
  $0 --action=enrich --transcription-id abc123 --llm-model qwen2.5-7b-instruct --text-correction
  $0 --action=enrich -tid abc123 -m phi-3-mini --prompts-file prompts.json
EOF
}

# Charger la configuration depuis le fichier (fonction pour recharger si n√©cessaire)
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        # R√©initialiser les variables apr√®s rechargement
        API_URL="${VOCALYX_API_URL:-${API_URL:-http://localhost:8000}}"
        USERNAME="${VOCALYX_USERNAME:-${USERNAME:-admin}}"
        PASSWORD="${VOCALYX_PASSWORD:-${PASSWORD:-}}"
        echo -e "${BLUE}‚úì Configuration charg√©e depuis $CONFIG_FILE${NC}" >&2
    fi
}

# R√©cup√©rer la cl√© API du projet via JWT
get_project_api_key() {
    local username=$1
    local password=$2
    local api_url=$3
    local project_name=$4
    local verbose=${5:-false}
    
    # Obtenir le token JWT
    if [ "$verbose" = "true" ]; then
        echo -e "${BLUE}üîê Authentification...${NC}" >&2
    fi
    local token_response=$(curl -s -X POST "${api_url}/api/auth/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "username=${username}&password=${password}")
    
    if ! echo "$token_response" | grep -q "access_token"; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Erreur d'authentification${NC}" >&2
            echo "$token_response" >&2
        else
            echo "$token_response" >&2
        fi
        return 1
    fi
    
    local token=$(echo "$token_response" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)
    
    if [ -z "$token" ]; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Impossible d'extraire le token${NC}" >&2
        fi
        return 1
    fi
    
    if [ "$verbose" = "true" ]; then
        echo -e "${GREEN}‚úì Authentification r√©ussie${NC}" >&2
    fi
    
    # R√©cup√©rer les projets avec leurs cl√©s API
    if [ "$verbose" = "true" ]; then
        echo -e "${BLUE}üîç R√©cup√©ration de la cl√© API du projet '${project_name}'...${NC}" >&2
    fi
    local projects_response=$(curl -s -X GET "${api_url}/api/user/projects" \
        -H "Authorization: Bearer ${token}")
    
    # Extraire la cl√© API du projet
    local api_key=$(echo "$projects_response" | grep -o "\"name\":\"${project_name}\"[^}]*\"api_key\":\"[^\"]*" | grep -o '"api_key":"[^"]*' | cut -d'"' -f4)
    
    if [ -z "$api_key" ]; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Projet '${project_name}' non trouv√© ou non accessible${NC}" >&2
            echo -e "${YELLOW}Projets disponibles:${NC}" >&2
            echo "$projects_response" | grep -o '"name":"[^"]*' | cut -d'"' -f4 | sed 's/^/  - /' >&2
        else
            echo "$projects_response" >&2
        fi
        return 1
    fi
    
    echo "$api_key"
}

# Action transcribe
action_transcribe() {
    # Variables pour les options
    local audio_file=""
    local project_name=""
    local whisper_model="small"
    local use_vad="true"
    local diarization="false"
    local verbose="false"
    
    # Parser les arguments sp√©cifiques √† transcribe
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_transcribe_help
                exit 0
                ;;
            -f|--file)
                audio_file="$2"
                shift 2
                ;;
            -P|--project)
                project_name="$2"
                shift 2
                ;;
            -m|--model)
                whisper_model="$2"
                shift 2
                ;;
            --no-vad)
                use_vad="false"
                shift
                ;;
            --diarization)
                diarization="true"
                shift
                ;;
            -v|--verbose)
                verbose="true"
                shift
                ;;
            -u|--username)
                USERNAME="$2"
                shift 2
                ;;
            -p|--password)
                PASSWORD="$2"
                shift 2
                ;;
            -a|--api-url)
                API_URL="$2"
                shift 2
                ;;
            -*)
                if [ "$verbose" = "true" ]; then
                    echo -e "${RED}‚ùå Option inconnue: $1${NC}" >&2
                else
                    echo "{\"error\": \"Option inconnue: $1\"}" >&2
                fi
                show_transcribe_help
                exit 1
                ;;
            *)
                if [ "$verbose" = "true" ]; then
                    echo -e "${RED}‚ùå Argument inattendu: $1${NC}" >&2
                    echo -e "${YELLOW}Utilisez -f/--file pour le fichier et -P/--project pour le projet${NC}" >&2
                else
                    echo "{\"error\": \"Argument inattendu: $1\"}" >&2
                fi
                show_transcribe_help
                exit 1
                ;;
        esac
    done
    
    # V√©rifier les arguments requis
    if [ -z "$audio_file" ] || [ -z "$project_name" ]; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Arguments manquants${NC}" >&2
        else
            echo "{\"error\": \"Arguments manquants: fichier audio et projet requis\"}" >&2
        fi
        show_transcribe_help
        exit 1
    fi
    
    # V√©rifier que le fichier existe
    if [ ! -f "$audio_file" ]; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Fichier audio introuvable: $audio_file${NC}" >&2
        else
            echo "{\"error\": \"Fichier audio introuvable: $audio_file\"}" >&2
        fi
        exit 1
    fi
    
    # Demander le mot de passe si non fourni
    if [ -z "$PASSWORD" ]; then
        if [ "$verbose" = "true" ]; then
            echo -n "Mot de passe pour $USERNAME: "
        fi
        read -s PASSWORD
        if [ "$verbose" = "true" ]; then
            echo ""
        fi
    fi
    
    # R√©cup√©rer la cl√© API (ou utiliser celle fournie en variable d'environnement)
    local api_key="${VOCALYX_PROJECT_API_KEY}"
    
    if [ -z "$api_key" ]; then
        api_key=$(get_project_api_key "$USERNAME" "$PASSWORD" "$API_URL" "$project_name" "$verbose")
        if [ $? -ne 0 ]; then
            exit 1
        fi
    else
        if [ "$verbose" = "true" ]; then
            echo -e "${GREEN}‚úì Utilisation de la cl√© API fournie${NC}" >&2
        fi
    fi
    
    # Cr√©er la transcription
    if [ "$verbose" = "true" ]; then
        echo -e "${BLUE}üì§ Envoi du fichier audio...${NC}" >&2
        echo -e "   Fichier: $audio_file" >&2
        echo -e "   Projet: $project_name" >&2
        echo -e "   Mod√®le: $whisper_model" >&2
    fi
    
    local response=$(curl -s -X POST "${API_URL}/api/transcriptions" \
        -H "X-API-Key: ${api_key}" \
        -F "file=@${audio_file}" \
        -F "project_name=${project_name}" \
        -F "whisper_model=${whisper_model}" \
        -F "use_vad=${use_vad}" \
        -F "diarization=${diarization}")
    
    # V√©rifier la r√©ponse
    if echo "$response" | grep -q '"id"'; then
        # Toujours afficher le JSON
        if command -v jq &> /dev/null; then
            echo "$response" | jq '.'
        else
            echo "$response"
        fi
        
        # Afficher les messages verbeux si demand√©
        if [ "$verbose" = "true" ]; then
            local transcription_id=$(echo "$response" | grep -o '"id":"[^"]*' | cut -d'"' -f4)
            local status=$(echo "$response" | grep -o '"status":"[^"]*' | cut -d'"' -f4)
            echo "" >&2
            echo -e "${GREEN}‚úì Transcription cr√©√©e avec succ√®s!${NC}" >&2
            echo "ID de transcription: $transcription_id" >&2
            echo "Statut: $status" >&2
            echo "" >&2
            echo "Pour suivre la progression:" >&2
            echo "  curl -H \"X-API-Key: ${api_key}\" ${API_URL}/api/user/transcriptions/${transcription_id} | jq" >&2
            echo "" >&2
            echo "Ou visitez le dashboard:" >&2
            echo "  ${API_URL%:8000}:8080" >&2
        fi
    else
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Erreur lors de la cr√©ation de la transcription${NC}" >&2
            echo "$response" >&2
        else
            echo "$response" >&2
        fi
        exit 1
    fi
}

# Action status
action_status() {
    local transcription_id=""
    local verbose="false"
    
    # Parser les arguments sp√©cifiques √† status
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_status_help
                exit 0
                ;;
            -tid|--transcription-id)
                transcription_id="$2"
                shift 2
                ;;
            -v|--verbose)
                verbose="true"
                shift
                ;;
            -u|--username)
                USERNAME="$2"
                shift 2
                ;;
            -p|--password)
                PASSWORD="$2"
                shift 2
                ;;
            -a|--api-url)
                API_URL="$2"
                shift 2
                ;;
            -*)
                if [ "$verbose" = "true" ]; then
                    echo -e "${RED}‚ùå Option inconnue: $1${NC}" >&2
                else
                    echo "{\"error\": \"Option inconnue: $1\"}" >&2
                fi
                show_status_help
                exit 1
                ;;
            *)
                if [ "$verbose" = "true" ]; then
                    echo -e "${RED}‚ùå Argument inattendu: $1${NC}" >&2
                    echo -e "${YELLOW}Utilisez -tid/--transcription-id pour l'ID de la transcription${NC}" >&2
                else
                    echo "{\"error\": \"Argument inattendu: $1\"}" >&2
                fi
                show_status_help
                exit 1
                ;;
        esac
    done
    
    # V√©rifier que l'ID est fourni
    if [ -z "$transcription_id" ]; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå ID de transcription requis${NC}" >&2
        else
            echo "{\"error\": \"ID de transcription requis\"}" >&2
        fi
        show_status_help
        exit 1
    fi
    
    # Demander le mot de passe si non fourni
    if [ -z "$PASSWORD" ]; then
        if [ "$verbose" = "true" ]; then
            echo -n "Mot de passe pour $USERNAME: "
        fi
        read -s PASSWORD
        if [ "$verbose" = "true" ]; then
            echo ""
        fi
    fi
    
    # Obtenir le token JWT
    if [ "$verbose" = "true" ]; then
        echo -e "${BLUE}üîê Authentification...${NC}" >&2
    fi
    local token_response=$(curl -s -X POST "${API_URL}/api/auth/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "username=${USERNAME}&password=${PASSWORD}")
    
    if ! echo "$token_response" | grep -q "access_token"; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Erreur d'authentification${NC}" >&2
            echo "$token_response" >&2
        else
            echo "$token_response" >&2
        fi
        exit 1
    fi
    
    local token=$(echo "$token_response" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)
    
    if [ -z "$token" ]; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Impossible d'extraire le token${NC}" >&2
        fi
        exit 1
    fi
    
    if [ "$verbose" = "true" ]; then
        echo -e "${GREEN}‚úì Authentification r√©ussie${NC}" >&2
    fi
    
    # R√©cup√©rer la transcription
    if [ "$verbose" = "true" ]; then
        echo -e "${BLUE}üì• R√©cup√©ration de la transcription '${transcription_id}'...${NC}" >&2
    fi
    local response=$(curl -s -X GET "${API_URL}/api/user/transcriptions/${transcription_id}" \
        -H "Authorization: Bearer ${token}")
    
    # V√©rifier si la transcription existe
    if echo "$response" | grep -q '"id"'; then
        # Toujours afficher le JSON
        if command -v jq &> /dev/null; then
            echo "$response" | jq '.'
        else
            echo "$response"
        fi
        
        # Afficher les messages verbeux si demand√©
        if [ "$verbose" = "true" ]; then
            local status=$(echo "$response" | grep -o '"status":"[^"]*' | cut -d'"' -f4)
            local project_name=$(echo "$response" | grep -o '"project_name":"[^"]*' | cut -d'"' -f4)
            local file_path=$(echo "$response" | grep -o '"file_path":"[^"]*' | cut -d'"' -f4)
            local text=$(echo "$response" | grep -o '"text":"[^"]*' | cut -d'"' -f4)
            
            echo "" >&2
            echo -e "${GREEN}‚úì Transcription trouv√©e${NC}" >&2
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" >&2
            echo "ID: $transcription_id" >&2
            echo "Statut: $status" >&2
            echo "Projet: $project_name" >&2
            echo "Fichier: $(basename "$file_path")" >&2
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" >&2
            echo "" >&2
            
            # Afficher le texte si disponible
            if [ -n "$text" ] && [ "$text" != "null" ]; then
                echo "üìù Transcription:" >&2
                echo "$text" | sed 's/\\n/\n/g' >&2
                echo "" >&2
            else
                if [ "$status" = "pending" ] || [ "$status" = "processing" ]; then
                    echo -e "${YELLOW}‚è≥ Transcription en cours...${NC}" >&2
                elif [ "$status" = "error" ]; then
                    local error_msg=$(echo "$response" | grep -o '"error_message":"[^"]*' | cut -d'"' -f4)
                    echo -e "${RED}‚ùå Erreur: ${error_msg}${NC}" >&2
                fi
            fi
        fi
    else
        # V√©rifier si c'est une erreur 404
        if echo "$response" | grep -q "not found"; then
            if [ "$verbose" = "true" ]; then
                echo -e "${RED}‚ùå Transcription '${transcription_id}' non trouv√©e${NC}" >&2
            else
                echo "$response" >&2
            fi
        else
            if [ "$verbose" = "true" ]; then
                echo -e "${RED}‚ùå Erreur lors de la r√©cup√©ration de la transcription${NC}" >&2
                echo "$response" >&2
            else
                echo "$response" >&2
            fi
        fi
        exit 1
    fi
}

# Action enrich
action_enrich() {
    local transcription_id=""
    local llm_model=""
    local text_correction=""
    local prompts_file=""
    local verbose="false"
    
    # Parser les arguments sp√©cifiques √† enrich
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_enrich_help
                exit 0
                ;;
            -tid|--transcription-id)
                transcription_id="$2"
                shift 2
                ;;
            -m|--llm-model)
                llm_model="$2"
                shift 2
                ;;
            --text-correction)
                text_correction="true"
                shift
                ;;
            --prompts-file)
                prompts_file="$2"
                shift 2
                ;;
            -v|--verbose)
                verbose="true"
                shift
                ;;
            -u|--username)
                USERNAME="$2"
                shift 2
                ;;
            -p|--password)
                PASSWORD="$2"
                shift 2
                ;;
            -a|--api-url)
                API_URL="$2"
                shift 2
                ;;
            -*)
                if [ "$verbose" = "true" ]; then
                    echo -e "${RED}‚ùå Option inconnue: $1${NC}" >&2
                else
                    echo "{\"error\": \"Option inconnue: $1\"}" >&2
                fi
                show_enrich_help
                exit 1
                ;;
            *)
                if [ "$verbose" = "true" ]; then
                    echo -e "${RED}‚ùå Argument inattendu: $1${NC}" >&2
                    echo -e "${YELLOW}Utilisez -tid/--transcription-id pour l'ID de la transcription${NC}" >&2
                else
                    echo "{\"error\": \"Argument inattendu: $1\"}" >&2
                fi
                show_enrich_help
                exit 1
                ;;
        esac
    done
    
    # V√©rifier que l'ID est fourni
    if [ -z "$transcription_id" ]; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå ID de transcription requis${NC}" >&2
        else
            echo "{\"error\": \"ID de transcription requis\"}" >&2
        fi
        show_enrich_help
        exit 1
    fi
    
    # Valider le mod√®le LLM si fourni
    if [ -n "$llm_model" ]; then
        case "$llm_model" in
            qwen2.5-7b-instruct|mistral-7b-instruct|phi-3-mini)
                ;;
            *)
                if [ "$verbose" = "true" ]; then
                    echo -e "${RED}‚ùå Mod√®le LLM invalide: $llm_model${NC}" >&2
                    echo -e "${YELLOW}Mod√®les valides: qwen2.5-7b-instruct, mistral-7b-instruct, phi-3-mini${NC}" >&2
                else
                    echo "{\"error\": \"Mod√®le LLM invalide: $llm_model\"}" >&2
                fi
                exit 1
                ;;
        esac
    fi
    
    # Lire le fichier de prompts si fourni
    local enrichment_prompts=""
    if [ -n "$prompts_file" ]; then
        if [ ! -f "$prompts_file" ]; then
            if [ "$verbose" = "true" ]; then
                echo -e "${RED}‚ùå Fichier de prompts introuvable: $prompts_file${NC}" >&2
            else
                echo "{\"error\": \"Fichier de prompts introuvable: $prompts_file\"}" >&2
            fi
            exit 1
        fi
        
        # V√©rifier que c'est du JSON valide
        if ! command -v jq &> /dev/null; then
            # Sans jq, on lit simplement le fichier
            enrichment_prompts=$(cat "$prompts_file")
        else
            # Avec jq, on valide le JSON
            if ! jq empty "$prompts_file" 2>/dev/null; then
                if [ "$verbose" = "true" ]; then
                    echo -e "${RED}‚ùå Fichier de prompts invalide (JSON invalide): $prompts_file${NC}" >&2
                else
                    echo "{\"error\": \"Fichier de prompts invalide (JSON invalide): $prompts_file\"}" >&2
                fi
                exit 1
            fi
            enrichment_prompts=$(cat "$prompts_file")
        fi
    fi
    
    # Demander le mot de passe si non fourni
    if [ -z "$PASSWORD" ]; then
        if [ "$verbose" = "true" ]; then
            echo -n "Mot de passe pour $USERNAME: "
        fi
        read -s PASSWORD
        if [ "$verbose" = "true" ]; then
            echo ""
        fi
    fi
    
    # Obtenir le token JWT
    if [ "$verbose" = "true" ]; then
        echo -e "${BLUE}üîê Authentification...${NC}" >&2
    fi
    local token_response=$(curl -s -X POST "${API_URL}/api/auth/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "username=${USERNAME}&password=${PASSWORD}")
    
    if ! echo "$token_response" | grep -q "access_token"; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Erreur d'authentification${NC}" >&2
            echo "$token_response" >&2
        else
            echo "$token_response" >&2
        fi
        exit 1
    fi
    
    local token=$(echo "$token_response" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)
    
    if [ -z "$token" ]; then
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Impossible d'extraire le token${NC}" >&2
        fi
        exit 1
    fi
    
    if [ "$verbose" = "true" ]; then
        echo -e "${GREEN}‚úì Authentification r√©ussie${NC}" >&2
    fi
    
    # Construire le body JSON pour la requ√™te
    local json_body="{"
    local first=true
    
    if [ -n "$llm_model" ]; then
        json_body="${json_body}\"llm_model\": \"${llm_model}\""
        first=false
    fi
    
    if [ -n "$text_correction" ]; then
        if [ "$first" = "false" ]; then
            json_body="${json_body}, "
        fi
        json_body="${json_body}\"text_correction\": ${text_correction}"
        first=false
    fi
    
    if [ -n "$enrichment_prompts" ]; then
        if [ "$first" = "false" ]; then
            json_body="${json_body}, "
        fi
        json_body="${json_body}\"enrichment_prompts\": ${enrichment_prompts}"
        first=false
    fi
    
    json_body="${json_body}}"
    
    # D√©clencher l'enrichissement
    if [ "$verbose" = "true" ]; then
        echo -e "${BLUE}üöÄ D√©clenchement de l'enrichissement pour la transcription '${transcription_id}'...${NC}" >&2
    fi
    
    local response=$(curl -s -X POST "${API_URL}/api/user/transcriptions/${transcription_id}/re-enrich" \
        -H "Authorization: Bearer ${token}" \
        -H "Content-Type: application/json" \
        -d "$json_body")
    
    # V√©rifier la r√©ponse
    if echo "$response" | grep -q '"task_id"'; then
        # Toujours afficher le JSON
        if command -v jq &> /dev/null; then
            echo "$response" | jq '.'
        else
            echo "$response"
        fi
        
        # Afficher les messages verbeux si demand√©
        if [ "$verbose" = "true" ]; then
            local task_id=$(echo "$response" | grep -o '"task_id":"[^"]*' | cut -d'"' -f4)
            local status=$(echo "$response" | grep -o '"status":"[^"]*' | cut -d'"' -f4)
            echo "" >&2
            echo -e "${GREEN}‚úì Enrichissement d√©clench√© avec succ√®s!${NC}" >&2
            echo "ID de t√¢che: $task_id" >&2
            echo "Statut: $status" >&2
            echo "" >&2
            echo "Pour suivre la progression:" >&2
            echo "  $0 --action=status -tid ${transcription_id}" >&2
        fi
    else
        if [ "$verbose" = "true" ]; then
            echo -e "${RED}‚ùå Erreur lors du d√©clenchement de l'enrichissement${NC}" >&2
            echo "$response" >&2
        else
            echo "$response" >&2
        fi
        exit 1
    fi
}

# Fonction principale
main() {
    # La configuration est d√©j√† charg√©e au d√©but du script
    # load_config() peut √™tre utilis√©e pour recharger si n√©cessaire
    
    # Variables pour les options globales
    local action=""
    
    # Parser les arguments globaux
    while [[ $# -gt 0 ]]; do
        case $1 in
            --action=*)
                action="${1#*=}"
                shift
                ;;
            --action)
                action="$2"
                shift 2
                ;;
            -h|--help)
                # Si une action est d√©j√† d√©finie, laisser --help passer √† l'action
                if [ -n "$action" ]; then
                    break
                fi
                show_help
                exit 0
                ;;
            -u|--username)
                USERNAME="$2"
                shift 2
                ;;
            -p|--password)
                PASSWORD="$2"
                shift 2
                ;;
            -a|--api-url)
                API_URL="$2"
                shift 2
                ;;
            *)
                # Si pas d'action d√©finie, afficher l'aide
                if [ -z "$action" ]; then
                    echo -e "${RED}‚ùå Action requise. Utilisez --action=<action>${NC}" >&2
                    echo ""
                    show_help
                    exit 1
                fi
                # Passer les arguments restants √† l'action
                break
                ;;
        esac
    done
    
    # V√©rifier qu'une action est sp√©cifi√©e
    if [ -z "$action" ]; then
        echo -e "${RED}‚ùå Action requise. Utilisez --action=<action>${NC}" >&2
        echo ""
        show_help
        exit 1
    fi
    
    # Ex√©cuter l'action appropri√©e
    case "$action" in
        transcribe)
            action_transcribe "$@"
            ;;
        status)
            action_status "$@"
            ;;
        enrich)
            action_enrich "$@"
            ;;
        *)
            echo -e "${RED}‚ùå Action inconnue: $action${NC}" >&2
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Ex√©cuter la fonction principale
main "$@"

