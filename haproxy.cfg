# ============================================================================
# HAProxy Configuration pour Vocalyx
# ============================================================================
# Load balancing entre 2 instances de l'API avec support WebSocket
# ============================================================================

global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 10s

# ============================================================================
# STATISTIQUES HAProxy (optionnel, sur port 8404)
# ============================================================================
listen stats
    bind *:8404
    stats enable
    stats uri /haproxy-stats
    stats refresh 30s
    stats admin if TRUE

# ============================================================================
# FRONTEND - Point d'entrée principal (port 8000)
# ============================================================================
frontend vocalyx_frontend
    bind *:8000
    mode http
    
    # ACL pour les WebSockets
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket hdr_beg(Host) -i ws
    
    # ACL pour Swagger/Redoc
    acl is_swagger path_beg /docs
    acl is_redoc path_beg /redoc
    acl is_openapi path_beg /openapi.json
    
    # ACL pour l'API REST
    acl is_api path_beg /api
    acl is_health path /health
    acl is_root path /
    
    # Routage vers les backends appropriés
    use_backend vocalyx_api_backend if is_websocket || is_api || is_swagger || is_redoc || is_openapi || is_health || is_root
    
    # Default backend
    default_backend vocalyx_api_backend

# ============================================================================
# BACKEND - API Vocalyx (Load Balancing)
# ============================================================================
backend vocalyx_api_backend
    mode http
    balance roundrobin
    
    # Options pour WebSocket
    option httpchk GET /health
    http-check expect status 200
    
    # Sticky sessions pour WebSocket (important pour maintenir la connexion)
    cookie SERVERID insert indirect nocache
    
    # Configuration pour WebSocket
    option forwardfor
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Proto http if !{ ssl_fc }
    
    # Timeouts pour WebSocket (plus longs)
    timeout tunnel 3600s
    
    # Serveurs backend
    server api-01 vocalyx-api-01:8000 check cookie api-01 inter 5s fall 3 rise 2
    server api-02 vocalyx-api-02:8000 check cookie api-02 inter 5s fall 3 rise 2

